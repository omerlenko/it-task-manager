{% extends "base.html" %}

{% block content %}

  <div class="container mt-4">
    <div class="row g-4">
      <h1 class="text-center">Dashboard</h1>

      <div>
        <form method="get" class="d-flex gap-3">
          <div>
            <label for="user-select">üë§Worker:</label>
            <select name="user_id" id="user-select" class="form-select" onchange="this.form.submit()">
              {% for user in users %}
                <option value="{{ user.id }}" {% if user.id == selected_user.id %}selected{% endif %}>
                  {{ user.first_name }} {{ user.last_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="project-select">üìÑProject:</label>
            <select name="project_id" id="project-select" class="form-select" onchange="this.form.submit()">
              <option value="">All Projects</option>
              {% for project in projects %}
                <option value="{{ project.id }}" {% if project.id == selected_project.id %}selected{% endif %}>
                  {{ project.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>

      <!-- Task Overview Card -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center fs-3">Task Overview</div>
          <div class="card-body d-flex flex-column justify-content-center p-4">
            <div class="d-flex align-items-center mb-2">
              <div class="circle clr-primary me-3"></div>
              <div class="fs-4 me-auto">Total Tasks</div>
              <div class="fs-2 fw-bold">
                <a href="{% url "task_manager:task-list" %}?assignees={{ selected_user.id }}" class="text-decoration-none text-dark">
                  {{ total_tasks }}‚ÜóÔ∏è
                </a>
              </div>
            </div>
            <div class="d-flex align-items-center mb-2">
              <div class="circle clr-warning me-3"></div>
              <div class="fs-4 me-auto">Pending</div>
              <div class="fs-2 fw-bold">
                <a href="{% url "task_manager:task-list" %}?assignees={{ selected_user.id }}&is_completed=False" class="text-decoration-none text-dark">
                  {{ pending_tasks }}‚ÜóÔ∏è
                </a>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <div class="circle clr-success me-3"></div>
              <div class="fs-4 me-auto">Completed</div>
              <div class="fs-2 fw-bold">
                <a href="{% url "task_manager:task-list" %}?assignees={{ selected_user.id }}&is_completed=True" class="text-decoration-none text-dark">
                  {{ completed_tasks }}‚ÜóÔ∏è
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upcoming Deadlines Card -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center fs-3">Upcoming Deadlines</div>
          <div class="card-body p-3">
            <ul class="list-group">
              {% with upcoming_deadlines.all|slice:3 as deadlines_preview %}
                {% for task in deadlines_preview %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <a href="{% url 'task_manager:task-detail' pk=task.id %}" class="text-decoration-none text-dark fs-5">
                      üìù {{ task.name }}
                    </a>
                    <span class="badge bg-danger">{{ task.deadline|date:"M d" }}</span>
                  </li>
                {% empty %}
                  <li class="list-group-item text-muted text-center">No upcoming tasks</li>
                {% endfor %}
              {% endwith %}
              {% if upcoming_deadlines.count > 3 %}
                <li class="list-group-item text-muted">...and {{  upcoming_deadlines.count|add:"-3" }} more</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Task Count by Priority -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center fs-3">Tasks by Priority</div>
          <div class="card-body d-flex flex-column justify-content-center p-4">
            {% for priority, count in task_priority_counts.items %}
              <div class="d-flex  align-items-center mb-2">

                <div class="circle me-3
                 {% if priority == "1" %} clr-danger
                 {% elif priority == "2" %} clr-warning
                 {% elif priority == "3" %} clr-primary
                 {% else %} clr-default
                 {% endif %}"></div>

                <span class="fs-4 me-auto">
                  {% if priority  == "1" %}Urgent
                  {% elif priority == "2" %}High
                  {% elif priority == "3" %} Medium
                  {% else %} Low
                  {% endif %}
                </span>

                <span class="fs-2 fw-bold">
                  <a href="{% url "task_manager:task-list" %}?priority={{ priority }}&assignees={{ request.user.id }}" class="text-decoration-none text-dark">
                    {{ count }}‚ÜóÔ∏è
                  </a>
                </span>

              </div>
            {% empty %}
              <p class="fs-5 text-muted text-center">No priority tasks</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Weekly Progress -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center fs-3">This Week's Progress</div>
          <div class="card-body d-flex flex-column justify-content-center text-center p-4">
            <div class="fs-4 mb-3"><strong>{{ weekly_completed_tasks }} / {{ weekly_total_tasks }}</strong> completed</div>
            <div class="progress mx-auto mb-3" style="height: 16px; width: 80%;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                   role="progressbar"
                   style="width: {{ weekly_completion_percentage }}%;"
                   aria-valuenow="{{ weekly_completion_percentage }}"
                   aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted fs-5">{{ weekly_completion_percentage }}% of this week's tasks done</small>
          </div>
        </div>
      </div>

      <!-- Active Projects -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center fs-3">Active Projects</div>
          <div class="card-body p-3">
            <ul class="list-group">
              {% with projects|slice:":3" as projects_preview %}
                {% for project in projects_preview %}
                  <li class="list-group-item">
                    <div class="d-flex flex-column gap-2">

                      <div class="d-flex align-items-center">
                        <span class="me-2" style="font-size:1.5rem;">üìÑ</span>
                        <a href="{% url "task_manager:project-detail" project.id %}" class="text-decoration-none text-dark fs-5">
                          {{ project.name }}
                        </a>
                      </div>

                      <div class="text-muted fs-6">
                        {{ project.description }}
                      </div>

                      {% if project.tasks.count > 0 %}
                        <div class="progress" style="height: 10px;">
                          <div class="progress-bar bg-success" role="progressbar" style="width: {{ project.completion_percentage }}%;" aria-valuenow="{{ project.completion_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">{{ project.completion_percentage }}% Complete</small>
                      {% else %}
                        <small class="text-muted">No tasks yet</small>
                      {% endif %}

                    </div>
                  </li>
                {% endfor %}
              {% endwith %}
              {% if projects.count > 3 %}
                <li class="list-group-item text-muted">...and {{ projects.count|add:"-3" }} more</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Teams Card -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center fs-3">Your Teams</div>
          <div class="card-body p-3">
            <ul class="list-group">
              {% with teams|slice:":3" as teams_preview %}
                {% for team in teams_preview %}
                  <li class="list-group-item">
                    <div class="d-flex flex-column gap-2">

                      <div class="d-flex align-items-center">
                        <span class="me-2" style="font-size:1.5rem;">üë•</span>
                        <a href="{% url 'task_manager:team-detail' team.id %}" class="text-decoration-none text-dark fs-5">
                          {{ team.name }}
                        </a>
                      </div>

                      {% with team.members.all|slice:":3" as members_preview %}
                        <div class="text-muted fs-6">
                          Members:
                          {% for member in members_preview %}
                            {{ member.first_name }} {{ member.last_name }}{% if not forloop.last %}, {% endif %}
                          {% endfor %}
                          {% if team.members.count > 3 %}
                            ...and {{ team.members.count|add:"-3" }} others
                          {% endif %}
                        </div>
                      {% endwith %}
                    </div>
                  </li>
                {% endfor %}
              {% endwith %}
              {% if teams.count > 3 %}
                <li class="list-group-item text-muted">...and {{ teams.count|add:"-3" }} more</li>
              {% endif %}
{#              <div class="fs-6 text-muted mt-3">You are a member of {{ user.teams.count }} team{% if user.teams.count != 1 %}s{% endif %}.</div>#}
            </ul>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <a href="{% url "task_manager:task-create" %}" class="btn btn-primary">Add New Task</a>
      </div>
    </div>
  </div>

{% endblock %}
